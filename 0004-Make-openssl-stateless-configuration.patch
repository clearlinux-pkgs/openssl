From b9c841dbb97d786ed2a6e32bf21269252b9682b5 Mon Sep 17 00:00:00 2001
From: "Jaime A. Garcia" <jaime.garcia.naranjo@intel.com>
Date: Wed, 18 May 2016 15:18:42 -0500
Subject: [PATCH 4/6] Make openssl stateless configuration

Signed-off-by: Jaime A. Garcia <jaime.garcia.naranjo@intel.com>
---
 Configure     | 32 +++++++++++++++++++++++++++++++-
 Makefile.org  |  9 +++++++--
 apps/Makefile |  1 +
 apps/apps.c   | 20 ++++++++++++++++++++
 e_os.h        |  1 +
 5 files changed, 60 insertions(+), 3 deletions(-)

diff --git a/Configure b/Configure
index a66ecec..250eb48 100755
--- a/Configure
+++ b/Configure
@@ -10,12 +10,14 @@ use strict;
 
 # see INSTALL for instructions.
 
-my $usage="Usage: Configure [no-<cipher> ...] [enable-<cipher> ...] [experimental-<cipher> ...] [-Dxxx] [-lxxx] [-Lxxx] [-fxxx] [-Kxxx] [no-hw-xxx|no-hw] [[no-]threads] [[no-]shared] [[no-]zlib|zlib-dynamic] [no-asm] [no-dso] [no-krb5] [sctp] [386] [--prefix=DIR] [--openssldir=OPENSSLDIR] [--with-xxx[=vvv]] [--test-sanity] os/compiler[:flags]\n";
+my $usage="Usage: Configure [no-<cipher> ...] [enable-<cipher> ...] [experimental-<cipher> ...] [-Dxxx] [-lxxx] [-Lxxx] [-fxxx] [-Kxxx] [no-hw-xxx|no-hw] [[no-]threads] [[no-]shared] [[no-]zlib|zlib-dynamic] [no-asm] [no-dso] [no-krb5] [sctp] [386] [--prefix=DIR] [--openssldir=OPENSSLDIR] [--openssldir_defaults=OPENSSLDIR_DEFAULTS] [--with-xxx[=vvv]] [--test-sanity] os/compiler[:flags]\n";
 
 # Options:
 #
 # --openssldir  install OpenSSL in OPENSSLDIR (Default: DIR/ssl if the
 #               --prefix option is given; /usr/local/ssl otherwise)
+# --openssldir_defaults  directory for stateless config (Default:
+#               /usr/share/defaults/ssl)
 # --prefix      prefix for the OpenSSL include, lib and bin directories
 #               (Default: the OPENSSLDIR directory)
 #
@@ -727,6 +729,7 @@ my $idx_multilib = $idx++;
 my $prefix="";
 my $libdir="";
 my $openssldir="";
+my $openssldir_defaults="";
 my $exe_ext="";
 my $install_prefix= "$ENV{'INSTALL_PREFIX'}";
 my $cross_compile_prefix="";
@@ -956,6 +959,10 @@ PROCESS_ARGS:
 				{
 				$openssldir=$1;
 				}
+			elsif (/^--openssldir_defaults=(.*)$/)
+				{
+				$openssldir_defaults=$1;
+				}
 			elsif (/^--install.prefix=(.*)$/)
 				{
 				$install_prefix=$1;
@@ -1194,6 +1201,7 @@ $exe_ext=".nlm" if ($target =~ /netware/);
 $exe_ext=".pm"  if ($target =~ /vos/);
 $openssldir="/usr/local/ssl" if ($openssldir eq "" and $prefix eq "");
 $prefix=$openssldir if $prefix eq "";
+$openssldir_defaults="/usr/share/defaults/ssl" if $openssldir_defaults eq "";
 
 $default_ranlib= &which("ranlib") or $default_ranlib="true";
 $perl=$ENV{'PERL'} or $perl=&which("perl5") or $perl=&which("perl")
@@ -1203,6 +1211,7 @@ my $make = $ENV{'MAKE'} || "make";
 $cross_compile_prefix=$ENV{'CROSS_COMPILE'} if $cross_compile_prefix eq "";
 
 chop $openssldir if $openssldir =~ /\/$/;
+chop $openssldir_defaults if $openssldir_defaults =~ /\/$/;
 chop $prefix if $prefix =~ /.\/$/;
 
 $openssldir=$prefix . "/ssl" if $openssldir eq "";
@@ -1709,6 +1718,7 @@ while (<IN>)
 	s/^INSTALLTOP=.*$/INSTALLTOP=$prefix/;
 	s/^MULTILIB=.*$/MULTILIB=$multilib/;
 	s/^OPENSSLDIR=.*$/OPENSSLDIR=$openssldir/;
+	s/^OPENSSLDIR_DEFAULTS=.*$/OPENSSLDIR_DEFAULTS=$openssldir_defaults/;
 	s/^LIBDIR=.*$/LIBDIR=$libdir/;
 	s/^INSTALL_PREFIX=.*$/INSTALL_PREFIX=$install_prefix/;
 	s/^PLATFORM=.*$/PLATFORM=$target/;
@@ -1988,6 +1998,26 @@ close(OUT);
 rename("crypto/opensslconf.h","crypto/opensslconf.h.bak") || die "unable to rename crypto/opensslconf.h\n" if -e "crypto/opensslconf.h";
 rename("crypto/opensslconf.h.new","crypto/opensslconf.h") || die "unable to rename crypto/opensslconf.h.new\n";
 
+# Include defaults dir
+open(IN,'<e_os.h') || die "unable to read e_os.h:$!\n";
+unlink("e_os.h.new") || die "unable to remove old e_os.h.new:$!\n" if -e "e_os.h.new";
+open(OUT,'>e_os.h.new') || die "unable to create e_os.h.new:$!\n";
+
+while (<IN>)
+	{
+	if	(/^#define\s+OPENSSLDIR_DEFAULTS/)
+		{
+		my $foo = $openssldir_defaults;
+		$foo =~ s/\\/\\\\/g;
+		print OUT "#define OPENSSLDIR_DEFAULTS \"$foo\"\n";
+		}
+	else
+		{ print OUT $_; }
+	}
+close(IN);
+close(OUT);
+rename("e_os.h","e_os.h.bak") || die "unable to rename e_os.h\n" if -e "e_os.h";
+rename("e_os.h.new","e_os.h") || die "unable to rename e_os.h.new\n";
 
 # Fix the date
 
diff --git a/Makefile.org b/Makefile.org
index 2377f50..f6baabb 100644
--- a/Makefile.org
+++ b/Makefile.org
@@ -29,6 +29,9 @@ INSTALLTOP=/usr/local/ssl
 # Do not edit this manually. Use Configure --openssldir=DIR do change this!
 OPENSSLDIR=/usr/local/ssl
 
+# Stateless default
+OPENSSLDIR_DEFAULTS=/usr/share/defaults/ssl
+
 # NO_IDEA - Define to build without the IDEA algorithm
 # NO_RC4  - Define to build without the RC4 algorithm
 # NO_RC2  - Define to build without the RC2 algorithm
@@ -215,6 +218,7 @@ BUILDENV=	LC_ALL=C PLATFORM='$(PLATFORM)' PROCESSOR='$(PROCESSOR)'\
 		SDIRS='$(SDIRS)' LIBRPATH='$(INSTALLTOP)/$(LIBDIR)'	\
 		INSTALL_PREFIX='$(INSTALL_PREFIX)'		\
 		INSTALLTOP='$(INSTALLTOP)' OPENSSLDIR='$(OPENSSLDIR)'	\
+		OPENSSLDIR_DEFAULTS='$(OPENSSLDIR_DEFAULTS)'	\
 		LIBDIR='$(LIBDIR)'				\
 		MAKEDEPEND='$$$${TOP}/util/domd $$$${TOP} -MD $(MAKEDEPPROG)' \
 		DEPFLAG='-DOPENSSL_NO_DEPRECATED $(DEPFLAG)'	\
@@ -412,7 +416,7 @@ libclean:
 	rm -f *.map *.so *.so.* *.dylib *.dll engines/*.so engines/*.dll engines/*.dylib *.a engines/*.a */lib */*/lib
 
 clean:	libclean
-	rm -f shlib/*.o *.o core a.out fluff rehash.time testlog make.log cctest cctest.c
+	rm -f shlib/*.o *.o core a.out fluff rehash.time testlog make.log cctest cctest.c e_os.h.bak
 	@set -e; target=clean; $(RECURSIVE_BUILD_CMD)
 	rm -f $(LIBS)
 	rm -f openssl.pc libssl.pc libcrypto.pc
@@ -541,7 +545,8 @@ install_sw:
 		$(INSTALL_PREFIX)$(INSTALLTOP)/include/openssl \
 		$(INSTALL_PREFIX)$(OPENSSLDIR)/misc \
 		$(INSTALL_PREFIX)$(OPENSSLDIR)/certs \
-		$(INSTALL_PREFIX)$(OPENSSLDIR)/private
+		$(INSTALL_PREFIX)$(OPENSSLDIR)/private \
+		$(INSTALL_PREFIX)$(OPENSSLDIR_DEFAULTS)
 	@set -e; headerlist="$(EXHEADER)"; for i in $$headerlist;\
 	do \
 	(cp $$i $(INSTALL_PREFIX)$(INSTALLTOP)/include/openssl/$$i; \
diff --git a/apps/Makefile b/apps/Makefile
index 8c3297e..913798d 100644
--- a/apps/Makefile
+++ b/apps/Makefile
@@ -119,6 +119,7 @@ install:
 	@cp openssl.cnf $(INSTALL_PREFIX)$(OPENSSLDIR)/openssl.cnf.new; \
 	chmod 644 $(INSTALL_PREFIX)$(OPENSSLDIR)/openssl.cnf.new; \
 	mv -f  $(INSTALL_PREFIX)$(OPENSSLDIR)/openssl.cnf.new $(INSTALL_PREFIX)$(OPENSSLDIR)/openssl.cnf
+	cp -f $(INSTALL_PREFIX)$(OPENSSLDIR)/openssl.cnf $(INSTALL_PREFIX)$(OPENSSLDIR_DEFAULTS)/openssl.cnf
 
 tags:
 	ctags $(SRC)
diff --git a/apps/apps.c b/apps/apps.c
index 9fdc3e0..2a449c7 100644
--- a/apps/apps.c
+++ b/apps/apps.c
@@ -120,6 +120,8 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sys/types.h>
+#include <sys/stat.h>
+#include <unistd.h>
 #include <ctype.h>
 #include <errno.h>
 #include <assert.h>
@@ -1595,6 +1597,8 @@ char *make_config_name()
     const char *t = X509_get_default_cert_area();
     size_t len;
     char *p;
+    int ret = 0;
+    struct stat st;
 
     len = strlen(t) + strlen(OPENSSL_CONF) + 2;
     p = OPENSSL_malloc(len);
@@ -1606,6 +1610,22 @@ char *make_config_name()
 #endif
     BUF_strlcat(p, OPENSSL_CONF, len);
 
+    ret = stat(p, &st);
+    if (ret == 0 && S_ISREG(st.st_mode))
+        return p;
+
+    OPENSSL_free(p);
+
+    len = strlen(OPENSSLDIR_DEFAULTS) + strlen(OPENSSL_CONF) + 2;
+    p = OPENSSL_malloc(len);
+    if (p == NULL)
+        return NULL;
+    BUF_strlcpy(p, OPENSSLDIR_DEFAULTS, len);
+#ifndef OPENSSL_SYS_VMS
+    BUF_strlcat(p, "/", len);
+#endif
+    BUF_strlcat(p, OPENSSL_CONF, len);
+
     return p;
 }
 
diff --git a/e_os.h b/e_os.h
index 1fa36c1..9d63a8b 100644
--- a/e_os.h
+++ b/e_os.h
@@ -487,6 +487,7 @@ typedef unsigned long clock_t;
 #    include <fcntl.h>
 #   endif
 
+#define OPENSSLDIR_DEFAULTS "/usr/share/defaults/ssl"
 #   define OPENSSL_CONF        "openssl.cnf"
 #   define SSLEAY_CONF         OPENSSL_CONF
 #   define RFILE               ".rnd"
-- 
2.10.0

